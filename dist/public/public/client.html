<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Order Execution Engine — POST → WebSocket Stream</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 700px;
      margin: 20px auto;
      background: #fafafa;
      padding: 20px;
      border-radius: 10px;
    }
    input, select {
      padding: 8px;
      margin: 5px 0 10px 0;
      width: 100%;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    button {
      padding: 10px;
      width: 100%;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      background: #0d6efd;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background: #0b5ed7;
    }
    #logBox {
      border: 1px solid #ccc;
      padding: 10px;
      background: white;
      height: 300px;
      overflow-y: auto;
      margin-top: 20px;
      white-space: pre-wrap;
      font-size: 14px;
    }
    .status-box {
      background: #fff3cd;
      padding: 10px;
      border: 1px solid #ffeeba;
      border-radius: 5px;
      margin-top: 10px;
      font-weight: bold;
    }
  </style>
</head>

<body>
  <h2>Order Execution Engine — POST → WebSocket Stream</h2>

  <label>Token In</label>
  <select id="tokenIn">
    <option value="SOL">SOL</option>
    <option value="USDC">USDC</option>
    <option value="BONK">BONK</option>
  </select>

  <label>Token Out</label>
  <select id="tokenOut">
    <option value="USDC">USDC</option>
    <option value="SOL">SOL</option>
  </select>

  <label>Amount</label>
  <input id="amount" type="number" value="5" />

  <button onclick="submitOrder()">Submit & Stream</button>

  <div class="status-box" id="status">Status: idle</div>

  <h3>Event Stream:</h3>
  <div id="logBox"></div>

  <script>
    function log(msg) {
      const box = document.getElementById("logBox");
      const ts = new Date().toLocaleTimeString();
      box.textContent += `[${ts}] ${msg}\n`;
      box.scrollTop = box.scrollHeight;
    }

    function setStatus(text) {
      document.getElementById("status").textContent = "Status: " + text;
    }

    async function submitOrder() {
      setStatus("submitting order...");
      log("Submitting POST /api/orders/execute");

      const body = {
        type: "market",
        tokenIn: document.getElementById("tokenIn").value,
        tokenOut: document.getElementById("tokenOut").value,
        amount: Number(document.getElementById("amount").value),
      };

      const res = await fetch("/api/orders/execute", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });

      const json = await res.json();
      log("Order queued: " + JSON.stringify(json));

      const orderId = json.orderId;

      // ⭐ FIXED WEBSOCKET PROTOCOL FOR PRODUCTION
      const protocol = window.location.protocol === "https:" ? "wss" : "ws";
      const wsUrl = `${protocol}://${window.location.host}${json.ws_url}`;
      log(`Connecting WebSocket to: ${wsUrl}`);

      const ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        log("WebSocket opened");
      };

      ws.onmessage = (msg) => {
        const data = JSON.parse(msg.data);
        setStatus(data.status);
        log("Event: " + JSON.stringify(data));
      };

      ws.onerror = () => {
        log("❌ WebSocket error");
      };

      ws.onclose = () => {
        log("WebSocket closed");
      };
    }
  </script>

</body>
</html>
